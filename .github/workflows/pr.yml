- name: Deploy via SSH on Server A
  uses: appleboy/ssh-action@v1.0.3
  with:
    host: ${{ vars.SSH_HOST }}
    username: ${{ vars.SSH_USER }}
    key: ${{ secrets.SSH_KEY }}
    script: |
      set -e

      export KUBECONFIG=/home/ubuntu/kubeconfigs/ci-config

      echo "=== ğŸ” SSH OK ==="
      whoami
      hostname

      echo "=== ğŸ“¦ KUBECTL ==="
      kubectl version --client
      kubectl get nodes

      PR_NUMBER=${{ github.event.pull_request.number }}
      NAMESPACE=pr-${PR_NUMBER}

      echo "=== ğŸ“‚ Namespace ${NAMESPACE} ==="
      kubectl get ns ${NAMESPACE} || kubectl create ns ${NAMESPACE}

      echo "=== ğŸš€ Deployment ==="
      sed "s|IMAGE_PLACEHOLDER|nginx:alpine|g" k8s/base/deployment.yml \
        | kubectl apply -n ${NAMESPACE} -f -

      echo "=== ğŸ”Œ Service ==="
      kubectl apply -n ${NAMESPACE} -f k8s/base/service.yml

      echo "=== ğŸŒ Ingress PR ==="
      sed "s|PR_NUMBER|${PR_NUMBER}|g" k8s/overlays/pr/ingress.yml \
        | kubectl apply -n ${NAMESPACE} -f -

      echo "âœ… PR publicado:"
      echo "https://pr-${PR_NUMBER}.cluster.stringtecnologiadf.org"
