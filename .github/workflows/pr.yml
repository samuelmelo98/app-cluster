name: Deploy PR Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH on Server A
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            set -e

            PR_NUMBER=${{ github.event.pull_request.number }}
            NAMESPACE=pr-${PR_NUMBER}

            echo "▶ Criando namespace ${NAMESPACE}"
            kubectl get ns ${NAMESPACE} || kubectl create ns ${NAMESPACE}

            echo "▶ Aplicando deployment e service"
            sed "s|IMAGE_PLACEHOLDER|nginx:alpine|g" k8s/base/deployment.yml | kubectl apply -n ${NAMESPACE} -f -
            kubectl apply -n ${NAMESPACE} -f k8s/base/service.yml

            echo "▶ Aplicando ingress PR"
            sed "s|PR_NUMBER|${PR_NUMBER}|g" k8s/overlays/pr/ingress.yml | kubectl apply -n ${NAMESPACE} -f -

            echo "✅ PR ${PR_NUMBER} publicado em:"
            echo "https://pr-${PR_NUMBER}.cluster.stringtecnologiadf.org"
